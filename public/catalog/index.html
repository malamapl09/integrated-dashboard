<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catalog Management - Plaza Lama</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="../shared/theme.css" rel="stylesheet">
</head>
<body>
    <div x-data="catalogApp()">
        <!-- Header -->
        <header class="unified-header catalog-header">
            <div class="header-content">
                <div class="header-title">
                    <a href="/" class="back-button">
                        <i class="fas fa-arrow-left"></i>
                    </a>
                    <i class="fas fa-boxes header-icon"></i>
                    Catalog Management
                </div>
                <div class="flex items-center space-x-4">
                    <div class="relative" x-data="{ showExportMenu: false }">
                        <button @click="showExportMenu = !showExportMenu" class="btn-secondary">
                            <i class="fas fa-download"></i>
                            Export
                            <i class="fas fa-chevron-down ml-1"></i>
                        </button>
                        <div x-show="showExportMenu" 
                             @click.away="showExportMenu = false"
                             class="absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-lg border border-gray-200 z-10">
                            <div class="py-2">
                                <button @click="exportCatalogStatus('pdf'); showExportMenu = false" 
                                        class="w-full text-left px-4 py-2 hover:bg-gray-50 flex items-center">
                                    <i class="fas fa-file-pdf text-red-500 mr-3"></i>
                                    Catalog Status (PDF)
                                </button>
                                <button @click="exportERPvsPIM('excel'); showExportMenu = false" 
                                        class="w-full text-left px-4 py-2 hover:bg-gray-50 flex items-center">
                                    <i class="fas fa-file-excel text-green-500 mr-3"></i>
                                    ERP vs PIM (Excel)
                                </button>
                                <button @click="exportCategoryComparison('excel'); showExportMenu = false" 
                                        class="w-full text-left px-4 py-2 hover:bg-gray-50 flex items-center">
                                    <i class="fas fa-file-excel text-green-500 mr-3"></i>
                                    Category Analysis (Excel)
                                </button>
                                <button @click="exportInventoryReport('excel'); showExportMenu = false" 
                                        class="w-full text-left px-4 py-2 hover:bg-gray-50 flex items-center">
                                    <i class="fas fa-file-excel text-green-500 mr-3"></i>
                                    Inventory Report (Excel)
                                </button>
                            </div>
                        </div>
                    </div>
                    <button @click="refreshData()" class="btn-catalog">
                        <i class="fas fa-sync-alt"></i>
                        Refresh
                    </button>
                </div>
            </div>
        </header>

        <!-- Content -->
        <main class="main-content">
            <!-- Module Overview -->
            <div class="mb-8">
                <div class="feature-card catalog">
                    <i class="feature-icon fas fa-boxes" aria-hidden="true"></i>
                    <h1 class="feature-title">Catalog Management System</h1>
                    <p class="feature-description">
                        Automated product catalog synchronization and management platform. Compare ERP vs PIM data, 
                        analyze inventory levels, and maintain product information consistency across all systems.
                    </p>
                    
                    <div class="feature-stats">
                        <div class="stat-item">
                            <div class="stat-value" x-text="stats.totalProducts.toLocaleString()" aria-live="polite">42,111</div>
                            <div class="stat-label">Total Products</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" x-text="stats.categories" aria-live="polite">156</div>
                            <div class="stat-label">Categories</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" x-text="stats.newProducts" aria-live="polite">24</div>
                            <div class="stat-label">New Products</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" x-text="stats.obsoleteProducts" aria-live="polite">7</div>
                            <div class="stat-label">Obsolete Products</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Feature Grid -->
            <section aria-labelledby="features-heading">
                <h2 id="features-heading" class="text-2xl font-bold text-gray-900 mb-6">Catalog Features</h2>
                <div class="feature-grid">
                    <!-- ERP Synchronization Feature -->
                    <div class="feature-card catalog" 
                         role="button" 
                         tabindex="0"
                         @click="syncERP()"
                         @keydown.enter="syncERP()"
                         @keydown.space.prevent="syncERP()"
                         aria-describedby="erp-sync-desc">
                        <i class="feature-icon fas fa-sync-alt" aria-hidden="true"></i>
                        <h3 class="feature-title">ERP Synchronization</h3>
                        <p id="erp-sync-desc" class="feature-description">
                            Synchronize product data with ERP system automatically or on-demand with conflict resolution.
                        </p>
                        <div class="mt-6">
                            <div class="btn btn-catalog">
                                <i class="fas fa-sync-alt" aria-hidden="true"></i>
                                Start Sync
                            </div>
                        </div>
                    </div>

                    <!-- Product Analysis Feature -->
                    <div class="feature-card catalog" 
                         role="button" 
                         tabindex="0"
                         @click="runAnalysis()"
                         @keydown.enter="runAnalysis()"
                         @keydown.space.prevent="runAnalysis()"
                         aria-describedby="analysis-desc">
                        <i class="feature-icon fas fa-search" aria-hidden="true"></i>
                        <h3 class="feature-title">Product Analysis</h3>
                        <p id="analysis-desc" class="feature-description">
                            Identify new and obsolete products through AI-powered analysis and market intelligence.
                        </p>
                        <div class="mt-6">
                            <div class="btn btn-catalog">
                                <i class="fas fa-chart-line" aria-hidden="true"></i>
                                Run Analysis
                            </div>
                        </div>
                    </div>

                    <!-- Category Management Feature -->
                    <div class="feature-card catalog" 
                         role="button" 
                         tabindex="0"
                         @click="manageCategories()"
                         @keydown.enter="manageCategories()"
                         @keydown.space.prevent="manageCategories()"
                         aria-describedby="category-desc">
                        <i class="feature-icon fas fa-layer-group" aria-hidden="true"></i>
                        <h3 class="feature-title">Category Management</h3>
                        <p id="category-desc" class="feature-description">
                            Organize products by categories with hierarchical structure and automated classification.
                        </p>
                        <div class="mt-6">
                            <div class="btn btn-catalog">
                                <i class="fas fa-cogs" aria-hidden="true"></i>
                                Manage Categories
                            </div>
                        </div>
                    </div>

                    <!-- Inventory Tracking Feature -->
                    <div class="feature-card catalog" 
                         role="button" 
                         tabindex="0"
                         @click="trackInventory()"
                         @keydown.enter="trackInventory()"
                         @keydown.space.prevent="trackInventory()"
                         aria-describedby="inventory-desc">
                        <i class="feature-icon fas fa-warehouse" aria-hidden="true"></i>
                        <h3 class="feature-title">Inventory Tracking</h3>
                        <p id="inventory-desc" class="feature-description">
                            Monitor stock levels, set reorder points, and track inventory movements across locations.
                        </p>
                        <div class="mt-6">
                            <div class="btn btn-catalog">
                                <i class="fas fa-boxes" aria-hidden="true"></i>
                                View Inventory
                            </div>
                        </div>
                    </div>

                    <!-- Price Management Feature -->
                    <div class="feature-card catalog" 
                         role="button" 
                         tabindex="0"
                         @click="managePrices()"
                         @keydown.enter="managePrices()"
                         @keydown.space.prevent="managePrices()"
                         aria-describedby="price-desc">
                        <i class="feature-icon fas fa-dollar-sign" aria-hidden="true"></i>
                        <h3 class="feature-title">Price Management</h3>
                        <p id="price-desc" class="feature-description">
                            Manage pricing strategies, bulk price updates, and competitive pricing analysis.
                        </p>
                        <div class="mt-6">
                            <div class="btn btn-catalog">
                                <i class="fas fa-tag" aria-hidden="true"></i>
                                Manage Pricing
                            </div>
                        </div>
                    </div>

                    <!-- Data Quality Feature -->
                    <div class="feature-card catalog" 
                         role="button" 
                         tabindex="0"
                         @click="checkDataQuality()"
                         @keydown.enter="checkDataQuality()"
                         @keydown.space.prevent="checkDataQuality()"
                         aria-describedby="quality-desc">
                        <i class="feature-icon fas fa-check-circle" aria-hidden="true"></i>
                        <h3 class="feature-title">Data Quality</h3>
                        <p id="quality-desc" class="feature-description">
                            Validate product data integrity, detect duplicates, and ensure catalog consistency.
                        </p>
                        <div class="mt-6">
                            <div class="btn btn-catalog">
                                <i class="fas fa-clipboard-check" aria-hidden="true"></i>
                                Quality Check
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Recent Activity -->
            <div class="theme-card" x-show="recentActivity.length > 0">
                <h3 class="text-lg font-semibold mb-4">Recent Activity</h3>
                <div class="space-y-3">
                    <template x-for="activity in recentActivity" :key="activity.id">
                        <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                            <i class="fas fa-info-circle text-blue-500 mr-3"></i>
                            <div class="flex-1">
                                <div class="text-sm font-medium" x-text="activity.description"></div>
                                <div class="text-xs text-gray-500" x-text="activity.timestamp"></div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </main>
    </div>

    <script>
        function catalogApp() {
            return {
                stats: {
                    totalProducts: 0,
                    categories: 0,
                    newProducts: 0,
                    obsoleteProducts: 0
                },
                recentActivity: [],
                loading: false,

                async init() {
                    await this.loadStats();
                    await this.loadRecentActivity();
                },

                async loadStats() {
                    try {
                        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                        if (!token) {
                            window.location.href = '/login.html';
                            return;
                        }

                        const response = await fetch('/api/catalog/stats', {
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        if (response.ok) {
                            const result = await response.json();
                            if (result.success) {
                                this.stats = result.data;
                            }
                        }
                    } catch (error) {
                        console.error('Error loading catalog stats:', error);
                    }
                },

                async loadRecentActivity() {
                    // Placeholder for recent activity
                    this.recentActivity = [
                        {
                            id: 1,
                            description: 'ERP sync completed successfully',
                            timestamp: new Date().toLocaleString()
                        }
                    ];
                },

                async refreshData() {
                    this.loading = true;
                    await Promise.all([
                        this.loadStats(),
                        this.loadRecentActivity()
                    ]);
                    this.loading = false;
                },

                async syncERP() {
                    alert('ERP synchronization will be implemented');
                },

                async runAnalysis() {
                    alert('Product analysis will be implemented');
                },

                async manageCategories() {
                    alert('Category management will be implemented');
                },
                
                async trackInventory() {
                    alert('Inventory tracking will be implemented');
                },
                
                async managePrices() {
                    alert('Price management will be implemented');
                },
                
                async checkDataQuality() {
                    alert('Data quality check will be implemented');
                },

                async exportCatalogStatus(format) {
                    try {
                        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                        const response = await fetch(`/api/catalog/export/status/${format}`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });

                        if (response.ok) {
                            const blob = await response.blob();
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `catalog_status_${new Date().toISOString().split('T')[0]}.${format}`;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            window.URL.revokeObjectURL(url);
                        } else {
                            alert('Export failed. Please try again.');
                        }
                    } catch (error) {
                        console.error('Export error:', error);
                        alert('Export failed. Please try again.');
                    }
                },

                async exportERPvsPIM(format) {
                    try {
                        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                        const response = await fetch(`/api/catalog/export/erp-pim/${format}`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });

                        if (response.ok) {
                            const blob = await response.blob();
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `erp_pim_comparison_${new Date().toISOString().split('T')[0]}.xlsx`;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            window.URL.revokeObjectURL(url);
                        } else {
                            alert('Export failed. Please try again.');
                        }
                    } catch (error) {
                        console.error('Export error:', error);
                        alert('Export failed. Please try again.');
                    }
                },

                async exportCategoryComparison(format) {
                    try {
                        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                        const response = await fetch(`/api/catalog/export/category/${format}`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });

                        if (response.ok) {
                            const blob = await response.blob();
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `category_comparison_${new Date().toISOString().split('T')[0]}.xlsx`;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            window.URL.revokeObjectURL(url);
                        } else {
                            alert('Export failed. Please try again.');
                        }
                    } catch (error) {
                        console.error('Export error:', error);
                        alert('Export failed. Please try again.');
                    }
                },

                async exportInventoryReport(format) {
                    try {
                        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                        const response = await fetch(`/api/catalog/export/inventory/${format}`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });

                        if (response.ok) {
                            const blob = await response.blob();
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `inventory_report_${new Date().toISOString().split('T')[0]}.xlsx`;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            window.URL.revokeObjectURL(url);
                        } else {
                            alert('Export failed. Please try again.');
                        }
                    } catch (error) {
                        console.error('Export error:', error);
                        alert('Export failed. Please try again.');
                    }
                }
            };
        }
    </script>
</body>
</html>