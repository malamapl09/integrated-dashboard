<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catalog Management - Plaza Lama</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="../shared/theme.css" rel="stylesheet">
</head>
<body>
    <div x-data="catalogApp()">
        <!-- Header -->
        <header class="unified-header catalog-header">
            <div class="header-content">
                <div class="header-title">
                    <a href="/" class="back-button">
                        <i class="fas fa-arrow-left"></i>
                    </a>
                    <i class="fas fa-boxes header-icon"></i>
                    Catalog Management
                </div>
                <div class="flex items-center space-x-4">
                    <div class="relative" x-data="{ showExportMenu: false }">
                        <button @click="showExportMenu = !showExportMenu" class="btn-secondary">
                            <i class="fas fa-download"></i>
                            Export
                            <i class="fas fa-chevron-down ml-1"></i>
                        </button>
                        <div x-show="showExportMenu" 
                             @click.away="showExportMenu = false"
                             class="absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-lg border border-gray-200 z-10">
                            <div class="py-2">
                                <button @click="exportCatalogStatus('pdf'); showExportMenu = false" 
                                        class="w-full text-left px-4 py-2 hover:bg-gray-50 flex items-center">
                                    <i class="fas fa-file-pdf text-red-500 mr-3"></i>
                                    Catalog Status (PDF)
                                </button>
                                <button @click="exportERPvsPIM('excel'); showExportMenu = false" 
                                        class="w-full text-left px-4 py-2 hover:bg-gray-50 flex items-center">
                                    <i class="fas fa-file-excel text-green-500 mr-3"></i>
                                    ERP vs PIM (Excel)
                                </button>
                                <button @click="exportCategoryComparison('excel'); showExportMenu = false" 
                                        class="w-full text-left px-4 py-2 hover:bg-gray-50 flex items-center">
                                    <i class="fas fa-file-excel text-green-500 mr-3"></i>
                                    Category Analysis (Excel)
                                </button>
                                <button @click="exportInventoryReport('excel'); showExportMenu = false" 
                                        class="w-full text-left px-4 py-2 hover:bg-gray-50 flex items-center">
                                    <i class="fas fa-file-excel text-green-500 mr-3"></i>
                                    Inventory Report (Excel)
                                </button>
                            </div>
                        </div>
                    </div>
                    <button @click="refreshData()" class="btn-catalog">
                        <i class="fas fa-sync-alt"></i>
                        Refresh
                    </button>
                </div>
            </div>
        </header>

        <!-- Content -->
        <main class="main-content">
            <!-- Stats Cards -->
            <div class="content-grid grid-4 mb-8">
                <div class="theme-card">
                    <div class="text-center">
                        <i class="fas fa-boxes text-3xl mb-3" style="color: var(--catalog-text);"></i>
                        <div class="text-2xl font-bold mb-1" x-text="stats.totalProducts.toLocaleString()">-</div>
                        <div class="text-sm text-gray-600">Total Products</div>
                    </div>
                </div>
                <div class="theme-card">
                    <div class="text-center">
                        <i class="fas fa-layer-group text-3xl mb-3" style="color: var(--catalog-text);"></i>
                        <div class="text-2xl font-bold mb-1" x-text="stats.categories">-</div>
                        <div class="text-sm text-gray-600">Categories</div>
                    </div>
                </div>
                <div class="theme-card">
                    <div class="text-center">
                        <i class="fas fa-plus-circle text-3xl mb-3 text-green-500"></i>
                        <div class="text-2xl font-bold mb-1" x-text="stats.newProducts">-</div>
                        <div class="text-sm text-gray-600">New Products</div>
                    </div>
                </div>
                <div class="theme-card">
                    <div class="text-center">
                        <i class="fas fa-exclamation-triangle text-3xl mb-3 text-orange-500"></i>
                        <div class="text-2xl font-bold mb-1" x-text="stats.obsoleteProducts">-</div>
                        <div class="text-sm text-gray-600">Obsolete Products</div>
                    </div>
                </div>
            </div>

            <!-- Main Feature Cards -->
            <div class="content-grid grid-3 mb-8">
                <div class="gradient-card catalog">
                    <div class="text-center">
                        <i class="fas fa-sync-alt text-4xl mb-4"></i>
                        <h3 class="text-xl font-bold mb-3">ERP Synchronization</h3>
                        <p class="text-sm opacity-90 mb-6">Synchronize product data with ERP system</p>
                        <button @click="syncERP()" class="btn-secondary">
                            <i class="fas fa-sync-alt"></i>
                            Start Sync
                        </button>
                    </div>
                </div>

                <div class="gradient-card catalog">
                    <div class="text-center">
                        <i class="fas fa-search text-4xl mb-4"></i>
                        <h3 class="text-xl font-bold mb-3">Product Analysis</h3>
                        <p class="text-sm opacity-90 mb-6">Identify new and obsolete products</p>
                        <button @click="runAnalysis()" class="btn-secondary">
                            <i class="fas fa-chart-line"></i>
                            Run Analysis
                        </button>
                    </div>
                </div>

                <div class="gradient-card catalog">
                    <div class="text-center">
                        <i class="fas fa-layer-group text-4xl mb-4"></i>
                        <h3 class="text-xl font-bold mb-3">Category Management</h3>
                        <p class="text-sm opacity-90 mb-6">Organize products by categories</p>
                        <button @click="manageCategories()" class="btn-secondary">
                            <i class="fas fa-cogs"></i>
                            Manage
                        </button>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="theme-card" x-show="recentActivity.length > 0">
                <h3 class="text-lg font-semibold mb-4">Recent Activity</h3>
                <div class="space-y-3">
                    <template x-for="activity in recentActivity" :key="activity.id">
                        <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                            <i class="fas fa-info-circle text-blue-500 mr-3"></i>
                            <div class="flex-1">
                                <div class="text-sm font-medium" x-text="activity.description"></div>
                                <div class="text-xs text-gray-500" x-text="activity.timestamp"></div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </main>
    </div>

    <script>
        function catalogApp() {
            return {
                stats: {
                    totalProducts: 0,
                    categories: 0,
                    newProducts: 0,
                    obsoleteProducts: 0
                },
                recentActivity: [],
                loading: false,

                async init() {
                    await this.loadStats();
                    await this.loadRecentActivity();
                },

                async loadStats() {
                    try {
                        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                        if (!token) {
                            window.location.href = '/login.html';
                            return;
                        }

                        const response = await fetch('/api/catalog/stats', {
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        if (response.ok) {
                            const result = await response.json();
                            if (result.success) {
                                this.stats = result.data;
                            }
                        }
                    } catch (error) {
                        console.error('Error loading catalog stats:', error);
                    }
                },

                async loadRecentActivity() {
                    // Placeholder for recent activity
                    this.recentActivity = [
                        {
                            id: 1,
                            description: 'ERP sync completed successfully',
                            timestamp: new Date().toLocaleString()
                        }
                    ];
                },

                async refreshData() {
                    this.loading = true;
                    await Promise.all([
                        this.loadStats(),
                        this.loadRecentActivity()
                    ]);
                    this.loading = false;
                },

                async syncERP() {
                    alert('ERP synchronization will be implemented');
                },

                async runAnalysis() {
                    alert('Product analysis will be implemented');
                },

                async manageCategories() {
                    alert('Category management will be implemented');
                },

                async exportCatalogStatus(format) {
                    try {
                        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                        const response = await fetch(`/api/catalog/export/status/${format}`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });

                        if (response.ok) {
                            const blob = await response.blob();
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `catalog_status_${new Date().toISOString().split('T')[0]}.${format}`;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            window.URL.revokeObjectURL(url);
                        } else {
                            alert('Export failed. Please try again.');
                        }
                    } catch (error) {
                        console.error('Export error:', error);
                        alert('Export failed. Please try again.');
                    }
                },

                async exportERPvsPIM(format) {
                    try {
                        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                        const response = await fetch(`/api/catalog/export/erp-pim/${format}`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });

                        if (response.ok) {
                            const blob = await response.blob();
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `erp_pim_comparison_${new Date().toISOString().split('T')[0]}.xlsx`;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            window.URL.revokeObjectURL(url);
                        } else {
                            alert('Export failed. Please try again.');
                        }
                    } catch (error) {
                        console.error('Export error:', error);
                        alert('Export failed. Please try again.');
                    }
                },

                async exportCategoryComparison(format) {
                    try {
                        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                        const response = await fetch(`/api/catalog/export/category/${format}`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });

                        if (response.ok) {
                            const blob = await response.blob();
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `category_comparison_${new Date().toISOString().split('T')[0]}.xlsx`;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            window.URL.revokeObjectURL(url);
                        } else {
                            alert('Export failed. Please try again.');
                        }
                    } catch (error) {
                        console.error('Export error:', error);
                        alert('Export failed. Please try again.');
                    }
                },

                async exportInventoryReport(format) {
                    try {
                        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                        const response = await fetch(`/api/catalog/export/inventory/${format}`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });

                        if (response.ok) {
                            const blob = await response.blob();
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `inventory_report_${new Date().toISOString().split('T')[0]}.xlsx`;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            window.URL.revokeObjectURL(url);
                        } else {
                            alert('Export failed. Please try again.');
                        }
                    } catch (error) {
                        console.error('Export error:', error);
                        alert('Export failed. Please try again.');
                    }
                }
            };
        }
    </script>
</body>
</html>