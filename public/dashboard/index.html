<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Integrated Plaza Lama Dashboard - Manage quotes, monitor logs, analyze catalog data, and track sales performance">
    <title>Integrated Dashboard - Plaza Lama</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="../shared/theme.css?v=2.1" rel="stylesheet">
</head>
<body>
    <!-- Skip Link for Screen Readers -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <div x-data="dashboardApp()" class="min-h-screen">
        <!-- Header -->
        <header class="page-header" role="banner">
            <div class="container">
                <h1 class="page-title">
                    <i class="fas fa-tachometer-alt" aria-hidden="true"></i>
                    <span>Plaza Lama Dashboard</span>
                </h1>
                
                <div class="flex items-center gap-4">
                    <div class="text-sm text-gray-500" aria-live="polite">
                        Last Updated: <span x-text="lastUpdated"></span>
                    </div>
                    <div class="text-sm text-gray-700" x-show="userRole" aria-live="polite">
                        Welcome, <span class="font-medium capitalize" x-text="userRole"></span>
                    </div>
                    <button 
                        @click="refreshStats()"
                        :disabled="isLoading"
                        :aria-busy="isLoading.toString()"
                        class="btn btn-primary"
                        aria-describedby="refresh-help"
                    >
                        <i class="fas fa-sync-alt" :class="{'animate-spin': isLoading}" aria-hidden="true"></i>
                        <span x-show="!isLoading">Refresh</span>
                        <span x-show="isLoading" class="sr-only">Refreshing data...</span>
                    </button>
                    <div id="refresh-help" class="sr-only">Updates all dashboard statistics and module data</div>
                    
                    <button 
                        @click="logout()"
                        class="btn btn-secondary"
                        aria-label="Sign out of dashboard"
                    >
                        <i class="fas fa-sign-out-alt" aria-hidden="true"></i>
                        Logout
                    </button>
                </div>
            </div>
        </header>

        <!-- System Alerts Bar -->
        <div x-show="systemAlert" class="system-alerts" :class="systemAlert?.type" role="alert" aria-live="assertive">
            <span x-text="systemAlert?.message">System maintenance scheduled for tonight at 11 PM EST</span>
            <button @click="systemAlert = null" class="alert-close" aria-label="Dismiss alert">
                <i class="fas fa-times" aria-hidden="true"></i>
            </button>
        </div>

        <!-- Main Content -->
        <main id="main-content" class="container" role="main">
            <!-- Enhanced Welcome Section -->
            <div class="welcome-section mb-8">
                <div class="welcome-header">
                    <h2 class="welcome-title">Plaza Lama Integrated Dashboard</h2>
                    <p class="welcome-subtitle">Your unified command center for comprehensive business management and analytics</p>
                </div>
                
                <!-- Enhanced System Status Bar -->
                <div class="system-status-bar">
                    <div class="status-indicators">
                        <div class="status-indicator status-online">
                            <i class="fas fa-check-circle" aria-hidden="true"></i>
                            <span>All Systems Operational</span>
                        </div>
                        <div class="status-detail">
                            <i class="fas fa-database text-green-500" aria-hidden="true"></i>
                            <span>Databases Connected</span>
                        </div>
                        <div class="status-detail">
                            <i class="fas fa-sync text-blue-500" aria-hidden="true"></i>
                            <span>Last sync: <span x-text="lastUpdated"></span></span>
                        </div>
                    </div>
                    <div class="system-metrics">
                        <div class="metric">
                            <span class="metric-value" x-text="(stats.quotes || 0)">0</span>
                            <span class="metric-label">Active Quotes</span>
                        </div>
                        <div class="metric">
                            <span class="metric-value" x-text="(stats.userActions || 0)">0</span>
                            <span class="metric-label">User Actions</span>
                        </div>
                        <div class="metric">
                            <span class="metric-value" x-text="(stats.products || 0).toLocaleString()">0</span>
                            <span class="metric-label">Products</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions" role="region" aria-labelledby="quick-actions-heading">
                <h2 id="quick-actions-heading" class="sr-only">Quick Actions</h2>
                <button @click="navigateToModule('quotes', 'new')" class="quick-action" aria-label="Create new quote">
                    <i class="quick-action-icon fas fa-plus" aria-hidden="true"></i>
                    <span class="quick-action-text">New Quote</span>
                </button>
                
                <button @click="exportReport('daily')" class="quick-action" aria-label="Export daily report">
                    <i class="quick-action-icon fas fa-download" aria-hidden="true"></i>
                    <span class="quick-action-text">Export Report</span>
                </button>
                
                <button @click="navigateToModule('logs', 'search')" class="quick-action" aria-label="Search activity logs">
                    <i class="quick-action-icon fas fa-search" aria-hidden="true"></i>
                    <span class="quick-action-text">Search Logs</span>
                </button>
                
                <button @click="navigateToModule('catalog', 'sync')" class="quick-action" aria-label="Sync catalog data">
                    <i class="quick-action-icon fas fa-sync-alt" aria-hidden="true"></i>
                    <span class="quick-action-text">Sync Catalog</span>
                </button>
                
                <button @click="navigateToModule('sales', 'analytics')" class="quick-action" aria-label="View sales analytics">
                    <i class="quick-action-icon fas fa-chart-bar" aria-hidden="true"></i>
                    <span class="quick-action-text">Analytics</span>
                </button>
            </div>

            <!-- Enhanced KPI Dashboard -->
            <section aria-labelledby="kpi-heading">
                <h2 id="kpi-heading" class="text-xl font-semibold text-gray-900 mb-6">Performance Overview</h2>
                <div class="grid grid-2 md:grid-4 gap-6 mb-12">
                    
                    <!-- Quotes KPI -->
                    <div class="kpi-card quotes" role="region" aria-labelledby="quotes-kpi">
                        <div class="kpi-header">
                            <h3 id="quotes-kpi" class="kpi-title">Total Quotes</h3>
                            <div class="kpi-trend positive" x-show="kpiData.quotes?.trend > 0">
                                <i class="fas fa-arrow-up" aria-hidden="true"></i>
                                <span x-text="`+${kpiData.quotes?.trend || 12}%`"></span>
                            </div>
                        </div>
                        <div class="kpi-value" x-text="(overview.quotes?.total || stats.quotes).toLocaleString()" aria-live="polite">156</div>
                        <div class="kpi-context" x-text="`${overview.quotes?.pending || 23} pending approval • ${overview.quotes?.thisMonth || 45} this month`">23 pending approval • 45 this month</div>
                        <div class="kpi-visual">
                            <div class="progress-bar">
                                <div class="progress-fill quotes" 
                                     :style="`width: ${Math.min(100, ((overview.quotes?.completed || 78) / (overview.quotes?.target || 100)) * 100)}%`"
                                     style="width: 78%"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Activity KPI -->
                    <div class="kpi-card logs" role="region" aria-labelledby="activity-kpi">
                        <div class="kpi-header">
                            <h3 id="activity-kpi" class="kpi-title">Recent Activity</h3>
                            <div class="kpi-trend positive" x-show="kpiData.activity?.trend > 0">
                                <i class="fas fa-arrow-up" aria-hidden="true"></i>
                                <span x-text="`+${kpiData.activity?.trend || 8}%`"></span>
                            </div>
                        </div>
                        <div class="kpi-value" x-text="(overview.activity?.recent || stats.userActions).toLocaleString()" aria-live="polite">1,247</div>
                        <div class="kpi-context" x-text="`${(overview.activity?.today || 89)} actions today • ${(overview.activity?.users || 12)} active users`">89 actions today • 12 active users</div>
                        <div class="kpi-visual">
                            <svg class="mini-chart" viewBox="0 0 100 40" aria-hidden="true">
                                <path class="sparkline logs" d="M5,30 L15,25 L25,28 L35,20 L45,15 L55,18 L65,12 L75,8 L85,10 L95,5"></path>
                            </svg>
                        </div>
                    </div>

                    <!-- Products KPI -->
                    <div class="kpi-card catalog" role="region" aria-labelledby="products-kpi">
                        <div class="kpi-header">
                            <h3 id="products-kpi" class="kpi-title">Product Catalog</h3>
                            <div class="kpi-trend neutral" x-show="kpiData.products?.trend === 0">
                                <i class="fas fa-minus" aria-hidden="true"></i>
                                <span>Stable</span>
                            </div>
                        </div>
                        <div class="kpi-value" x-text="(overview.products?.total || stats.products).toLocaleString()" aria-live="polite">42,111</div>
                        <div class="kpi-context" x-text="`${(overview.products?.categories || 156)} categories • Last sync: ${overview.products?.lastSync || 'Today 3:45 PM'}`">156 categories • Last sync: Today 3:45 PM</div>
                        <div class="kpi-visual">
                            <div class="progress-bar">
                                <div class="progress-fill catalog" 
                                     :style="`width: ${Math.min(100, ((overview.products?.synced || 95) / 100) * 100)}%`"
                                     style="width: 95%"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Sales KPI -->
                    <div class="kpi-card sales" role="region" aria-labelledby="sales-kpi">
                        <div class="kpi-header">
                            <h3 id="sales-kpi" class="kpi-title">Monthly Revenue</h3>
                            <div class="kpi-trend positive" x-show="kpiData.sales?.trend > 0">
                                <i class="fas fa-arrow-up" aria-hidden="true"></i>
                                <span x-text="`+${kpiData.sales?.trend || 15}%`"></span>
                            </div>
                        </div>
                        <div class="kpi-value" x-text="formatCurrency(overview.sales?.monthly || stats.salesRevenue)" aria-live="polite">$245,780</div>
                        <div class="kpi-context" x-text="`${(overview.sales?.orders || 1456).toLocaleString()} orders • Target: ${formatCurrency(overview.sales?.target || 280000)}`">1,456 orders • Target: $280,000</div>
                        <div class="kpi-visual">
                            <svg class="mini-chart" viewBox="0 0 100 40" aria-hidden="true">
                                <path class="sparkline sales" d="M5,35 L15,32 L25,28 L35,25 L45,20 L55,15 L65,12 L75,8 L85,5 L95,3"></path>
                            </svg>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Insights and Activity Section -->
            <div class="insights-section mb-12">
                <!-- Actionable Insights Panel -->
                <div class="insights-panel">
                    <div class="insights-header">
                        <h2 class="insights-title">Action Required</h2>
                        <button @click="refreshInsights()" class="btn btn-secondary" aria-label="Refresh insights">
                            <i class="fas fa-sync-alt" aria-hidden="true"></i>
                        </button>
                    </div>
                    
                    <div class="space-y-3">
                        <!-- Urgent Item -->
                        <div class="insight-item urgent" role="alert">
                            <div class="insight-icon urgent">
                                <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>
                            </div>
                            <div class="insight-content">
                                <h3 class="insight-title">15 quotes expire today</h3>
                                <p class="insight-description">These quotes are about to expire and need immediate follow-up to prevent potential loss.</p>
                                <div class="insight-actions">
                                    <button @click="navigateToModule('quotes', 'expiring')" class="btn btn-primary">Review Quotes</button>
                                    <button @click="sendReminders()" class="btn btn-secondary">Send Reminders</button>
                                </div>
                            </div>
                        </div>

                        <!-- Warning Item -->
                        <div class="insight-item warning">
                            <div class="insight-icon warning">
                                <i class="fas fa-exclamation-circle" aria-hidden="true"></i>
                            </div>
                            <div class="insight-content">
                                <h3 class="insight-title">Catalog sync failed</h3>
                                <p class="insight-description">Last sync attempt failed 2 hours ago. Product data may be outdated.</p>
                                <div class="insight-actions">
                                    <button @click="navigateToModule('catalog', 'sync')" class="btn btn-primary">Retry Sync</button>
                                </div>
                            </div>
                        </div>

                        <!-- Success Item -->
                        <div class="insight-item success">
                            <div class="insight-icon success">
                                <i class="fas fa-check-circle" aria-hidden="true"></i>
                            </div>
                            <div class="insight-content">
                                <h3 class="insight-title">Sales target exceeded</h3>
                                <p class="insight-description">Monthly target reached 5 days early! Current performance: 112% of target.</p>
                                <div class="insight-actions">
                                    <button @click="navigateToModule('sales', 'analytics')" class="btn btn-secondary">View Details</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity Stream -->
                <div class="activity-stream">
                    <div class="activity-header">
                        <h2 class="activity-title">Recent Activity</h2>
                        <a href="/logs/" class="btn btn-secondary" aria-label="View all activity logs">
                            View All
                        </a>
                    </div>
                    
                    <div class="space-y-0">
                        <div class="activity-item">
                            <div class="activity-avatar" style="background: var(--quotes-primary);">JD</div>
                            <div class="activity-content">
                                <p class="activity-text"><strong>John Doe</strong> created quote #2024-156 for Acme Corp</p>
                                <time class="activity-time" datetime="2024-01-13T10:30:00">2 minutes ago</time>
                            </div>
                        </div>

                        <div class="activity-item">
                            <div class="activity-avatar" style="background: var(--catalog-primary);">SY</div>
                            <div class="activity-content">
                                <p class="activity-text"><strong>System</strong> synchronized 1,247 products from ERP</p>
                                <time class="activity-time" datetime="2024-01-13T10:25:00">7 minutes ago</time>
                            </div>
                        </div>

                        <div class="activity-item">
                            <div class="activity-avatar" style="background: var(--sales-primary);">MR</div>
                            <div class="activity-content">
                                <p class="activity-text"><strong>Maria Rodriguez</strong> generated monthly sales report</p>
                                <time class="activity-time" datetime="2024-01-13T10:15:00">17 minutes ago</time>
                            </div>
                        </div>

                        <div class="activity-item">
                            <div class="activity-avatar" style="background: var(--logs-primary);">AL</div>
                            <div class="activity-content">
                                <p class="activity-text"><strong>Admin</strong> updated user permissions for 3 accounts</p>
                                <time class="activity-time" datetime="2024-01-13T09:45:00">47 minutes ago</time>
                            </div>
                        </div>

                        <div class="activity-item">
                            <div class="activity-avatar" style="background: var(--quotes-primary);">CP</div>
                            <div class="activity-content">
                                <p class="activity-text"><strong>Carlos Perez</strong> converted quote #2024-151 to invoice</p>
                                <time class="activity-time" datetime="2024-01-13T09:30:00">1 hour ago</time>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enhanced Module Navigation -->
            <section aria-labelledby="modules-heading" class="module-section">
                <div class="section-header">
                    <h2 id="modules-heading" class="section-title">Business Modules</h2>
                    <p class="section-subtitle">Access integrated tools for comprehensive business management</p>
                </div>
                <div class="content-grid grid-4 gap-6 mb-12">
                    <!-- Enhanced Quotes Module -->
                    <a href="/quotes/" 
                       class="feature-card quotes"
                       x-show="canAccessModule('quotes')"
                       role="button"
                       tabindex="0"
                       aria-describedby="quotes-description"
                       @click.prevent="navigateToModule('quotes')"
                       @keydown.enter.prevent="navigateToModule('quotes')"
                       @keydown.space.prevent="navigateToModule('quotes')">
                        <div class="feature-header">
                            <div class="feature-icon quotes">
                                <i class="fas fa-file-invoice-dollar" aria-hidden="true"></i>
                            </div>
                            <div class="feature-badge">Professional</div>
                        </div>
                        <div class="feature-content">
                            <h3 class="feature-title">Quote Management</h3>
                            <p id="quotes-description" class="feature-description">
                                Professional quote and invoice management with PDF generation and client relationship tools
                            </p>
                        </div>
                        <div class="feature-stats">
                            <div class="stat-item">
                                <span class="stat-value" x-text="stats.quotes || '0'">0</span>
                                <span class="stat-label">Active Quotes</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value">PDFs</span>
                                <span class="stat-label">Generated</span>
                            </div>
                        </div>
                        <div class="feature-action">
                            <span>Manage Quotes</span>
                            <i class="fas fa-arrow-right" aria-hidden="true"></i>
                        </div>
                    </a>

                    <!-- Enhanced Logs Module -->
                    <a href="/logs/" 
                       class="feature-card logs"
                       x-show="canAccessModule('logs')"
                       role="button"
                       tabindex="0"
                       aria-describedby="logs-description"
                       @click.prevent="navigateToModule('logs')"
                       @keydown.enter.prevent="navigateToModule('logs')"
                       @keydown.space.prevent="navigateToModule('logs')">
                        <div class="feature-header">
                            <div class="feature-icon logs">
                                <i class="fas fa-shield-alt" aria-hidden="true"></i>
                            </div>
                            <div class="feature-badge">Security</div>
                        </div>
                        <div class="feature-content">
                            <h3 class="feature-title">Activity Monitoring</h3>
                            <p id="logs-description" class="feature-description">
                                Real-time user activity tracking and security audit with comprehensive behavior analysis
                            </p>
                        </div>
                        <div class="feature-stats">
                            <div class="stat-item">
                                <span class="stat-value" x-text="stats.userActions || '0'">0</span>
                                <span class="stat-label">User Actions</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value">Live</span>
                                <span class="stat-label">Monitoring</span>
                            </div>
                        </div>
                        <div class="feature-action">
                            <span>View Logs</span>
                            <i class="fas fa-arrow-right" aria-hidden="true"></i>
                        </div>
                    </a>

                    <!-- Enhanced Catalog Module -->
                    <a href="/catalog/" 
                       class="feature-card catalog"
                       x-show="canAccessModule('catalog')"
                       role="button"
                       tabindex="0"
                       aria-describedby="catalog-description"
                       @click.prevent="navigateToModule('catalog')"
                       @keydown.enter.prevent="navigateToModule('catalog')"
                       @keydown.space.prevent="navigateToModule('catalog')">
                        <div class="feature-header">
                            <div class="feature-icon catalog">
                                <i class="fas fa-database" aria-hidden="true"></i>
                            </div>
                            <div class="feature-badge">Data Sync</div>
                        </div>
                        <div class="feature-content">
                            <h3 class="feature-title">Catalog Management</h3>
                            <p id="catalog-description" class="feature-description">
                                Automated ERP-PIM synchronization with intelligent product analysis and inventory optimization
                            </p>
                        </div>
                        <div class="feature-stats">
                            <div class="stat-item">
                                <span class="stat-value" x-text="(stats.products || 0).toLocaleString()">0</span>
                                <span class="stat-label">Products</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value">Auto</span>
                                <span class="stat-label">Sync</span>
                            </div>
                        </div>
                        <div class="feature-action">
                            <span>Manage Catalog</span>
                            <i class="fas fa-arrow-right" aria-hidden="true"></i>
                        </div>
                    </a>

                    <!-- Enhanced Sales Module -->
                    <a href="/sales/" 
                       class="feature-card sales"
                       x-show="canAccessModule('sales')"
                       role="button"
                       tabindex="0"
                       aria-describedby="sales-description"
                       @click.prevent="navigateToModule('sales')"
                       @keydown.enter.prevent="navigateToModule('sales')"
                       @keydown.space.prevent="navigateToModule('sales')">
                        <div class="feature-header">
                            <div class="feature-icon sales">
                                <i class="fas fa-chart-line" aria-hidden="true"></i>
                            </div>
                            <div class="feature-badge">Analytics</div>
                        </div>
                        <div class="feature-content">
                            <h3 class="feature-title">Sales Analytics</h3>
                            <p id="sales-description" class="feature-description">
                                Advanced sales performance tracking with real-time revenue insights and customer analytics
                            </p>
                        </div>
                        <div class="feature-stats">
                            <div class="stat-item">
                                <span class="stat-value" x-text="formatCurrency(stats.salesRevenue || 0)">$0</span>
                                <span class="stat-label">Revenue</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value">Live</span>
                                <span class="stat-label">Tracking</span>
                            </div>
                        </div>
                        <div class="feature-action">
                            <span>View Analytics</span>
                            <i class="fas fa-arrow-right" aria-hidden="true"></i>
                        </div>
                    </a>

                    <!-- System Monitoring Module -->
                    <a href="/monitoring/" 
                       class="module-card monitoring"
                       x-show="canAccessModule('monitoring')"
                       role="button"
                       tabindex="0"
                       aria-describedby="monitoring-description"
                       @click.prevent="navigateToModule('monitoring')"
                       @keydown.enter.prevent="navigateToModule('monitoring')"
                       @keydown.space.prevent="navigateToModule('monitoring')">
                        <i class="module-icon fas fa-heartbeat" aria-hidden="true"></i>
                        <h3 class="module-title">System Monitor</h3>
                        <p id="monitoring-description" class="module-description">
                            Real-time system health and application monitoring. Track performance metrics and errors.
                        </p>
                        <div class="mt-4 p-3 bg-gray-100 rounded-lg">
                            <div class="text-sm text-gray-600">System Status</div>
                            <div class="text-xl font-bold" 
                                 :class="systemStatus === 'healthy' ? 'text-green-600' : 'text-red-600'" 
                                 x-text="systemStatus.toUpperCase()" 
                                 aria-live="polite"></div>
                        </div>
                    </a>
                </div>
            </section>

        </main>
        
        <!-- Mobile Bottom Navigation -->
        <nav class="mobile-bottom-nav" role="navigation" aria-label="Mobile navigation">
            <a href="/dashboard/" class="mobile-nav-item active" aria-label="Dashboard home">
                <i class="mobile-nav-icon fas fa-tachometer-alt" aria-hidden="true"></i>
                <span class="mobile-nav-text">Dashboard</span>
            </a>
            
            <a href="/quotes/" class="mobile-nav-item" aria-label="Quote management" x-show="canAccessModule('quotes')">
                <i class="mobile-nav-icon fas fa-file-invoice-dollar" aria-hidden="true"></i>
                <span class="mobile-nav-text">Quotes</span>
            </a>
            
            <a href="/logs/" class="mobile-nav-item" aria-label="Activity logs" x-show="canAccessModule('logs')">
                <i class="mobile-nav-icon fas fa-user-edit" aria-hidden="true"></i>
                <span class="mobile-nav-text">Logs</span>
            </a>
            
            <a href="/catalog/" class="mobile-nav-item" aria-label="Catalog management" x-show="canAccessModule('catalog')">
                <i class="mobile-nav-icon fas fa-boxes" aria-hidden="true"></i>
                <span class="mobile-nav-text">Catalog</span>
            </a>
            
            <a href="/sales/" class="mobile-nav-item" aria-label="Sales analytics" x-show="canAccessModule('sales')">
                <i class="mobile-nav-icon fas fa-chart-line" aria-hidden="true"></i>
                <span class="mobile-nav-text">Sales</span>
            </a>
        </nav>
        
        <!-- Live Region for Announcements -->
        <div aria-live="assertive" aria-atomic="true" class="sr-only" x-text="announcement"></div>
        
        <!-- Loading Overlay -->
        <div x-show="isLoading" class="fixed inset-0 bg-black bg-opacity-25 flex items-center justify-center z-50" aria-hidden="true">
            <div class="bg-white rounded-lg p-6 flex items-center gap-3">
                <div class="animate-spin w-6 h-6 border-2 border-primary-200 border-t-primary-600 rounded-full" role="status" aria-label="Loading"></div>
                <span class="text-gray-700">Loading dashboard data...</span>
            </div>
        </div>
    </div>

    <script>
        function dashboardApp() {
            return {
                lastUpdated: new Date().toLocaleString(),
                isLoading: false,
                announcement: '',
                systemAlert: {
                    type: 'info',
                    message: 'System maintenance scheduled for tonight at 11 PM EST'
                },
                stats: {
                    quotes: 156,
                    userActions: 1247,
                    products: 42111,
                    salesRevenue: 245780
                },
                overview: {
                    quotes: { total: 156, pending: 23, thisMonth: 45, completed: 78, target: 100 },
                    activity: { recent: 1247, today: 89, users: 12, logs: 15028 },
                    products: { total: 42111, categories: 156, lastSync: 'Today 3:45 PM', synced: 95 },
                    sales: { monthly: 245780, orders: 1456, target: 280000, source: 'ERP' }
                },
                kpiData: {
                    quotes: { trend: 12 },
                    activity: { trend: 8 },
                    products: { trend: 0 },
                    sales: { trend: 15 }
                },
                systemStatus: 'healthy',
                userRole: 'admin',
                
                async init() {
                    try {
                        this.isLoading = true;
                        console.log('Dashboard: Starting initialization...');
                        
                        // Add timeout fallback
                        const initTimeout = setTimeout(() => {
                            console.warn('Dashboard: Init timeout - forcing loading state off');
                            this.isLoading = false;
                        }, 10000); // 10 second timeout
                        
                        console.log('Dashboard: Loading stats...');
                        await this.refreshStats();
                        console.log('Dashboard: Stats loaded');
                        
                        console.log('Dashboard: Loading user role...');
                        await this.loadUserRole();
                        console.log('Dashboard: User role loaded');
                        
                        console.log('Dashboard: Loading system status...');
                        await this.loadSystemStatus();
                        console.log('Dashboard: System status loaded');
                        
                        clearTimeout(initTimeout);
                        this.isLoading = false;
                        console.log('Dashboard: Initialization complete');
                    } catch (error) {
                        console.error('Dashboard init error:', error);
                        this.isLoading = false;
                    }
                },
                
                // Enhanced Dashboard Functions
                formatCurrency(amount) {
                    return new Intl.NumberFormat('en-US', {
                        style: 'currency',
                        currency: 'USD',
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 0
                    }).format(amount);
                },
                
                canAccessModule(module) {
                    // Simple role-based access control
                    const modulePermissions = {
                        quotes: ['admin', 'manager', 'sales'],
                        logs: ['admin', 'manager'],
                        catalog: ['admin', 'manager', 'analyst'],
                        sales: ['admin', 'manager', 'sales', 'analyst'],
                        monitoring: ['admin']
                    };
                    return modulePermissions[module]?.includes(this.userRole) || false;
                },
                
                isAdmin() {
                    return this.userRole === 'admin';
                },
                
                async exportReport(type = 'daily') {
                    this.isLoading = true;
                    this.announcement = `Generating ${type} report...`;
                    
                    try {
                        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                        const response = await fetch(`/api/dashboard/export/${type}`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        
                        if (response.ok) {
                            const blob = await response.blob();
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `dashboard-${type}-report-${new Date().toISOString().split('T')[0]}.xlsx`;
                            a.click();
                            this.announcement = 'Report downloaded successfully';
                        } else {
                            throw new Error('Failed to generate report');
                        }
                    } catch (error) {
                        console.error('Export error:', error);
                        this.announcement = 'Failed to export report';
                    }
                    
                    this.isLoading = false;
                    setTimeout(() => this.announcement = '', 3000);
                },
                
                async refreshInsights() {
                    this.isLoading = true;
                    this.announcement = 'Refreshing insights...';
                    
                    try {
                        await this.refreshStats();
                        this.announcement = 'Insights updated';
                    } catch (error) {
                        this.announcement = 'Failed to refresh insights';
                    }
                    
                    this.isLoading = false;
                    setTimeout(() => this.announcement = '', 2000);
                },
                
                async sendReminders() {
                    this.isLoading = true;
                    this.announcement = 'Sending quote reminders...';
                    
                    try {
                        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                        const response = await fetch('/api/quotes/send-reminders', {
                            method: 'POST',
                            headers: { 
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (response.ok) {
                            this.announcement = 'Reminders sent successfully';
                        } else {
                            throw new Error('Failed to send reminders');
                        }
                    } catch (error) {
                        console.error('Reminder error:', error);
                        this.announcement = 'Failed to send reminders';
                    }
                    
                    this.isLoading = false;
                    setTimeout(() => this.announcement = '', 3000);
                },

                async refreshStats() {
                    try {
                        // Only set loading if not already set by init()
                        if (!this.isLoading) {
                            this.isLoading = true;
                        }
                        
                        // Fetch comprehensive dashboard overview
                        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                        if (!token) {
                            // No token - redirect to login
                            console.log('No token found, redirecting to login');
                            window.location.href = '/login.html';
                            return;
                        }
                        
                        const response = await fetch('/api/dashboard/overview', {
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (!response.ok) {
                            if (response.status === 401) {
                                window.location.href = '/login.html';
                                return;
                            }
                            throw new Error('Failed to fetch dashboard data');
                        }
                        
                        const result = await response.json();
                        if (result.success) {
                            this.overview = result.data;
                            
                            // Update simplified stats for compatibility
                            this.stats.quotes = this.overview.quotes.total;
                            this.stats.userActions = this.overview.activity.recent;
                            this.stats.products = this.overview.products.total;
                            this.stats.salesRevenue = this.overview.sales.monthly;
                        }
                        
                        this.lastUpdated = new Date().toLocaleString();
                        
                    } catch (error) {
                        console.error('Error refreshing stats:', error);
                        // Only set loading false if we're not in init (init handles it)
                        if (this.isLoading) {
                            this.isLoading = false;
                        }
                        throw error; // Re-throw so init() can handle it
                    }
                },
                
                // Enhanced navigation with action support
                navigateToModule(module, action = null) {
                    let url;
                    switch (module) {
                        case 'quotes':
                            window.location.href = '/quotes-content/';
                            break;
                        case 'logs':
                            window.location.href = '/logs-content/';
                            break;
                        case 'catalog':
                            window.location.href = '/catalog/';
                            break;
                        case 'sales':
                            window.location.href = '/sales/';
                            break;
                        case 'monitoring':
                            window.location.href = '/monitoring/';
                            break;
                    }
                },
                
                quickAction(action) {
                    switch (action) {
                        case 'new-quote':
                            window.location.href = '/quotes-content/?action=new';
                            break;
                        case 'recent-logs':
                            window.location.href = '/logs-content/?filter=recent';
                            break;
                        case 'catalog-sync':
                            window.location.href = '/catalog/?action=sync';
                            break;
                        case 'sales-report':
                            window.location.href = '/sales/?view=report';
                            break;
                        case 'user-management':
                            window.location.href = '/user-management/';
                            break;
                        case 'system-monitoring':
                            window.location.href = '/monitoring/';
                            break;
                    }
                },

                async loadUserRole() {
                    try {
                        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                        console.log('Dashboard: Checking for token...', token ? 'Found' : 'Not found');
                        
                        if (!token) {
                            // No token - redirect to login
                            console.log('Dashboard: No token found, redirecting to login');
                            window.location.href = '/login.html';
                            return;
                        }

                        console.log('Dashboard: Making profile request with token');
                        const response = await fetch('/api/auth/profile', {
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        console.log('Dashboard: Profile response status:', response.status);
                        
                        if (response.ok) {
                            const result = await response.json();
                            console.log('Dashboard: Profile response data:', result);
                            
                            if (result.success) {
                                this.userRole = result.data.role;
                                console.log('Dashboard: User role loaded:', this.userRole);
                                console.log('Dashboard: Module visibility check:');
                                console.log('- Quotes:', this.canAccessModule('quotes'));
                                console.log('- Logs:', this.canAccessModule('logs'));
                                console.log('- Catalog:', this.canAccessModule('catalog'));
                                console.log('- Sales:', this.canAccessModule('sales'));
                                console.log('- Monitoring:', this.canAccessModule('monitoring'));
                            }
                        } else if (response.status === 401) {
                            // Token invalid - redirect to login
                            console.log('Dashboard: Token invalid, redirecting to login');
                            localStorage.removeItem('token');
                            sessionStorage.removeItem('token');
                            window.location.href = '/login.html';
                        }
                    } catch (error) {
                        console.error('Dashboard: Error loading user role:', error);
                        // On error, assume no auth - redirect to login
                        window.location.href = '/login.html';
                    }
                },

                async loadSystemStatus() {
                    try {
                        const response = await fetch('/api/monitoring/health');
                        if (response.ok) {
                            const result = await response.json();
                            if (result.success) {
                                this.systemStatus = result.data.status || 'unknown';
                            }
                        }
                    } catch (error) {
                        console.error('Error loading system status:', error);
                        this.systemStatus = 'unknown';
                    }
                },

                isAdmin() {
                    return this.userRole === 'admin';
                },

                isManager() {
                    return this.userRole === 'manager' || this.userRole === 'admin';
                },

                canAccessModule(module) {
                    if (!this.userRole) return false;

                    const permissions = {
                        'quotes': ['admin', 'manager', 'user'],
                        'logs': ['admin', 'manager'],
                        'catalog': ['admin', 'manager', 'user'],
                        'sales': ['admin', 'manager'],
                        'monitoring': ['admin']
                    };

                    return permissions[module]?.includes(this.userRole) || false;
                },
                

                formatCurrency(amount) {
                    return new Intl.NumberFormat('es-DO', {
                        style: 'currency',
                        currency: 'DOP'
                    }).format(amount);
                },

                logout() {
                    // Clear stored tokens
                    localStorage.removeItem('token');
                    localStorage.removeItem('refreshToken');
                    sessionStorage.removeItem('token');
                    sessionStorage.removeItem('refreshToken');

                    // Redirect to login page
                    window.location.href = '/login.html';
                }
            };
        }
    </script>
</body>
</html>