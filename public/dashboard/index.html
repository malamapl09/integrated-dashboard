<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Integrated Plaza Lama Dashboard - Manage quotes, monitor logs, analyze catalog data, and track sales performance">
    <title>Integrated Dashboard - Plaza Lama</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="../shared/theme.css" rel="stylesheet">
</head>
<body>
    <!-- Skip Link for Screen Readers -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <div x-data="dashboardApp()" class="min-h-screen">
        <!-- Header -->
        <header class="page-header" role="banner">
            <div class="container">
                <h1 class="page-title">
                    <i class="fas fa-tachometer-alt" aria-hidden="true"></i>
                    <span>Plaza Lama Dashboard</span>
                </h1>
                
                <div class="flex items-center gap-4">
                    <div class="text-sm text-gray-500" aria-live="polite">
                        Last Updated: <span x-text="lastUpdated"></span>
                    </div>
                    <div class="text-sm text-gray-700" x-show="userRole" aria-live="polite">
                        Welcome, <span class="font-medium capitalize" x-text="userRole"></span>
                    </div>
                    <button 
                        @click="refreshStats()"
                        :disabled="isLoading"
                        :aria-busy="isLoading.toString()"
                        class="btn btn-primary"
                        aria-describedby="refresh-help"
                    >
                        <i class="fas fa-sync-alt" :class="{'animate-spin': isLoading}" aria-hidden="true"></i>
                        <span x-show="!isLoading">Refresh</span>
                        <span x-show="isLoading" class="sr-only">Refreshing data...</span>
                    </button>
                    <div id="refresh-help" class="sr-only">Updates all dashboard statistics and module data</div>
                    
                    <button 
                        @click="logout()"
                        class="btn btn-secondary"
                        aria-label="Sign out of dashboard"
                    >
                        <i class="fas fa-sign-out-alt" aria-hidden="true"></i>
                        Logout
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main id="main-content" class="container" role="main">
            <!-- Welcome Section -->
            <div class="mb-12">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">Welcome to the Integrated Management System</h2>
                <p class="text-gray-600 text-lg">Access all your business modules from one central location.</p>
            </div>

            <!-- Stats Overview -->
            <section aria-labelledby="stats-heading">
                <h2 id="stats-heading" class="sr-only">Dashboard Statistics Overview</h2>
                <div class="grid grid-2 md:grid-4 gap-6 mb-12">
                    <!-- Quotes Card -->
                    <div class="card" role="region" aria-labelledby="quotes-stat">
                        <div class="card-body flex items-center justify-between">
                            <div>
                                <h3 id="quotes-stat" class="text-sm font-medium text-gray-600">Total Quotes</h3>
                                <p class="text-3xl font-bold text-quotes-primary" x-text="overview.quotes?.total || stats.quotes" aria-live="polite"></p>
                                <p class="text-sm text-gray-500 mt-1" x-show="overview.quotes" x-text="`${overview.quotes?.pending || 0} pending`"></p>
                            </div>
                            <i class="fas fa-file-invoice-dollar text-4xl text-quotes-secondary" aria-hidden="true"></i>
                        </div>
                    </div>
                    
                    <!-- Activity Card -->
                    <div class="card" role="region" aria-labelledby="activity-stat">
                        <div class="card-body flex items-center justify-between">
                            <div>
                                <h3 id="activity-stat" class="text-sm font-medium text-gray-600">Recent Activity</h3>
                                <p class="text-3xl font-bold text-logs-primary" x-text="overview.activity?.recent || stats.userActions" aria-live="polite"></p>
                                <p class="text-sm text-gray-500 mt-1" x-show="overview.activity" x-text="`${(overview.activity?.logs || 0).toLocaleString()} total logs`"></p>
                            </div>
                            <i class="fas fa-history text-4xl text-logs-secondary" aria-hidden="true"></i>
                        </div>
                    </div>
                    
                    <!-- Products Card -->
                    <div class="card" role="region" aria-labelledby="products-stat">
                        <div class="card-body flex items-center justify-between">
                            <div>
                                <h3 id="products-stat" class="text-sm font-medium text-gray-600">Products</h3>
                                <p class="text-3xl font-bold text-catalog-primary" x-text="(overview.products?.total || stats.products).toLocaleString()" aria-live="polite"></p>
                                <p class="text-sm text-gray-500 mt-1" x-show="overview.products" x-text="`${overview.products?.categories || 0} categories`"></p>
                            </div>
                            <i class="fas fa-boxes text-4xl text-catalog-secondary" aria-hidden="true"></i>
                        </div>
                    </div>
                    
                    <!-- Sales Card -->
                    <div class="card" role="region" aria-labelledby="sales-stat">
                        <div class="card-body flex items-center justify-between">
                            <div>
                                <h3 id="sales-stat" class="text-sm font-medium text-gray-600">Monthly Revenue</h3>
                                <p class="text-2xl font-bold text-sales-primary" x-text="formatCurrency(overview.sales?.monthly || stats.salesRevenue)" aria-live="polite"></p>
                                <p class="text-sm text-gray-500 mt-1" x-show="overview.sales" x-text="`${(overview.sales?.orders || 0).toLocaleString()} orders (${overview.sales?.source || 'Unknown'})`"></p>
                            </div>
                            <i class="fas fa-chart-line text-4xl text-sales-secondary" aria-hidden="true"></i>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Module Navigation -->
            <section aria-labelledby="modules-heading">
                <h2 id="modules-heading" class="text-2xl font-bold text-gray-900 mb-6">Business Modules</h2>
                <div class="grid grid-2 md:grid-3 lg:grid-4 xl:grid-5 gap-6 mb-12">
                    <!-- Quotes Module -->
                    <a href="/quotes/" 
                       class="module-card quotes"
                       x-show="canAccessModule('quotes')"
                       role="button"
                       tabindex="0"
                       aria-describedby="quotes-description"
                       @click.prevent="navigateToModule('quotes')"
                       @keydown.enter.prevent="navigateToModule('quotes')"
                       @keydown.space.prevent="navigateToModule('quotes')">
                        <i class="module-icon fas fa-file-invoice-dollar" aria-hidden="true"></i>
                        <h3 class="module-title">Quote Management</h3>
                        <p id="quotes-description" class="module-description">
                            Create, manage, and track customer quotes and invoices. Generate PDFs and manage client relationships.
                        </p>
                        <div class="mt-4 p-3 bg-gray-100 rounded-lg">
                            <div class="text-sm text-gray-600">Active Quotes</div>
                            <div class="text-xl font-bold text-gray-900" x-text="stats.quotes" aria-live="polite"></div>
                        </div>
                    </a>

                    <!-- User Logs Module -->
                    <a href="/logs/" 
                       class="module-card logs"
                       x-show="canAccessModule('logs')"
                       role="button"
                       tabindex="0"
                       aria-describedby="logs-description"
                       @click.prevent="navigateToModule('logs')"
                       @keydown.enter.prevent="navigateToModule('logs')"
                       @keydown.space.prevent="navigateToModule('logs')">
                        <i class="module-icon fas fa-user-edit" aria-hidden="true"></i>
                        <h3 class="module-title">User Activity Logs</h3>
                        <p id="logs-description" class="module-description">
                            Monitor and audit user actions and system changes. Track security events and user behavior.
                        </p>
                        <div class="mt-4 p-3 bg-gray-100 rounded-lg">
                            <div class="text-sm text-gray-600">Recent Actions</div>
                            <div class="text-xl font-bold text-gray-900" x-text="stats.userActions" aria-live="polite"></div>
                        </div>
                    </a>

                    <!-- Catalog Module -->
                    <a href="/catalog/" 
                       class="module-card catalog"
                       x-show="canAccessModule('catalog')"
                       role="button"
                       tabindex="0"
                       aria-describedby="catalog-description"
                       @click.prevent="navigateToModule('catalog')"
                       @keydown.enter.prevent="navigateToModule('catalog')"
                       @keydown.space.prevent="navigateToModule('catalog')">
                        <i class="module-icon fas fa-boxes" aria-hidden="true"></i>
                        <h3 class="module-title">Catalog Management</h3>
                        <p id="catalog-description" class="module-description">
                            Automated product catalog sync and management. Compare ERP vs PIM data and analyze inventory.
                        </p>
                        <div class="mt-4 p-3 bg-gray-100 rounded-lg">
                            <div class="text-sm text-gray-600">Total Products</div>
                            <div class="text-xl font-bold text-gray-900" x-text="stats.products.toLocaleString()" aria-live="polite"></div>
                        </div>
                    </a>

                    <!-- Sales Analytics Module -->
                    <a href="/sales/" 
                       class="module-card sales"
                       x-show="canAccessModule('sales')"
                       role="button"
                       tabindex="0"
                       aria-describedby="sales-description"
                       @click.prevent="navigateToModule('sales')"
                       @keydown.enter.prevent="navigateToModule('sales')"
                       @keydown.space.prevent="navigateToModule('sales')">
                        <i class="module-icon fas fa-chart-line" aria-hidden="true"></i>
                        <h3 class="module-title">Sales Analytics</h3>
                        <p id="sales-description" class="module-description">
                            Real-time sales metrics and performance analysis. Track revenue, orders, and customer insights.
                        </p>
                        <div class="mt-4 p-3 bg-gray-100 rounded-lg">
                            <div class="text-sm text-gray-600">Monthly Revenue</div>
                            <div class="text-xl font-bold text-gray-900" x-text="formatCurrency(stats.salesRevenue)" aria-live="polite"></div>
                        </div>
                    </a>

                    <!-- System Monitoring Module -->
                    <a href="/monitoring/" 
                       class="module-card monitoring"
                       x-show="canAccessModule('monitoring')"
                       role="button"
                       tabindex="0"
                       aria-describedby="monitoring-description"
                       @click.prevent="navigateToModule('monitoring')"
                       @keydown.enter.prevent="navigateToModule('monitoring')"
                       @keydown.space.prevent="navigateToModule('monitoring')">
                        <i class="module-icon fas fa-heartbeat" aria-hidden="true"></i>
                        <h3 class="module-title">System Monitor</h3>
                        <p id="monitoring-description" class="module-description">
                            Real-time system health and application monitoring. Track performance metrics and errors.
                        </p>
                        <div class="mt-4 p-3 bg-gray-100 rounded-lg">
                            <div class="text-sm text-gray-600">System Status</div>
                            <div class="text-xl font-bold" 
                                 :class="systemStatus === 'healthy' ? 'text-green-600' : 'text-red-600'" 
                                 x-text="systemStatus.toUpperCase()" 
                                 aria-live="polite"></div>
                        </div>
                    </a>
                </div>
            </section>

            <!-- Quick Actions -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Quick Actions</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <button @click="quickAction('new-quote')" class="bg-blue-50 hover:bg-blue-100 text-blue-600 px-4 py-3 rounded-lg transition-colors text-left"
                            x-show="canAccessModule('quotes')">
                        <i class="fas fa-plus-circle mr-2"></i>
                        Create New Quote
                    </button>
                    <button @click="quickAction('recent-logs')" class="bg-pink-50 hover:bg-pink-100 text-pink-600 px-4 py-3 rounded-lg transition-colors text-left"
                            x-show="canAccessModule('logs')">
                        <i class="fas fa-history mr-2"></i>
                        View Recent Logs
                    </button>
                    <button @click="quickAction('catalog-sync')" class="bg-cyan-50 hover:bg-cyan-100 text-cyan-600 px-4 py-3 rounded-lg transition-colors text-left"
                            x-show="canAccessModule('catalog')">
                        <i class="fas fa-sync-alt mr-2"></i>
                        Sync Catalog
                    </button>
                    <button @click="quickAction('sales-report')" class="bg-green-50 hover:bg-green-100 text-green-600 px-4 py-3 rounded-lg transition-colors text-left"
                            x-show="canAccessModule('sales')">
                        <i class="fas fa-chart-bar mr-2"></i>
                        Generate Report
                    </button>
                    <button @click="quickAction('user-management')" class="bg-purple-50 hover:bg-purple-100 text-purple-600 px-4 py-3 rounded-lg transition-colors text-left"
                            x-show="isAdmin()">
                        <i class="fas fa-users-cog mr-2"></i>
                        Manage Users
                    </button>
                    <button @click="quickAction('system-monitoring')" class="bg-gray-50 hover:bg-gray-100 text-gray-600 px-4 py-3 rounded-lg transition-colors text-left"
                            x-show="canAccessModule('monitoring')">
                        <i class="fas fa-heartbeat mr-2"></i>
                        System Monitor
                    </button>
                </div>
            </div>
        </main>
        
        <!-- Live Region for Announcements -->
        <div aria-live="assertive" aria-atomic="true" class="sr-only" x-text="announcement"></div>
        
        <!-- Loading Overlay -->
        <div x-show="isLoading" class="fixed inset-0 bg-black bg-opacity-25 flex items-center justify-center z-50" aria-hidden="true">
            <div class="bg-white rounded-lg p-6 flex items-center gap-3">
                <div class="animate-spin w-6 h-6 border-2 border-primary-200 border-t-primary-600 rounded-full" role="status" aria-label="Loading"></div>
                <span class="text-gray-700">Loading dashboard data...</span>
            </div>
        </div>
    </div>

    <script>
        function dashboardApp() {
            return {
                lastUpdated: new Date().toLocaleString(),
                stats: {
                    quotes: 0,
                    userActions: 0,
                    products: 0,
                    salesRevenue: 0
                },
                overview: {},
                systemStatus: 'healthy',
                loading: true,
                userRole: null,
                
                async init() {
                    await this.refreshStats();
                    await this.loadUserRole();
                    await this.loadSystemStatus();
                },
                
                async refreshStats() {
                    try {
                        this.loading = true;
                        
                        // Fetch comprehensive dashboard overview
                        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                        if (!token) {
                            // No token - redirect to login
                            console.log('No token found, redirecting to login');
                            window.location.href = '/login.html';
                            return;
                        }
                        
                        const response = await fetch('/api/dashboard/overview', {
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (!response.ok) {
                            if (response.status === 401) {
                                window.location.href = '/login.html';
                                return;
                            }
                            throw new Error('Failed to fetch dashboard data');
                        }
                        
                        const result = await response.json();
                        if (result.success) {
                            this.overview = result.data;
                            
                            // Update simplified stats for compatibility
                            this.stats.quotes = this.overview.quotes.total;
                            this.stats.userActions = this.overview.activity.recent;
                            this.stats.products = this.overview.products.total;
                            this.stats.salesRevenue = this.overview.sales.monthly;
                        }
                        
                        this.lastUpdated = new Date().toLocaleString();
                        this.loading = false;
                        
                    } catch (error) {
                        console.error('Error refreshing stats:', error);
                        this.loading = false;
                    }
                },
                
                navigateToModule(module) {
                    // Navigate to specific module with full functionality
                    switch (module) {
                        case 'quotes':
                            window.location.href = '/quotes-content/';
                            break;
                        case 'logs':
                            window.location.href = '/logs-content/';
                            break;
                        case 'catalog':
                            window.location.href = '/catalog/';
                            break;
                        case 'sales':
                            window.location.href = '/sales/';
                            break;
                        case 'monitoring':
                            window.location.href = '/monitoring/';
                            break;
                    }
                },
                
                quickAction(action) {
                    switch (action) {
                        case 'new-quote':
                            window.location.href = '/quotes-content/?action=new';
                            break;
                        case 'recent-logs':
                            window.location.href = '/logs-content/?filter=recent';
                            break;
                        case 'catalog-sync':
                            window.location.href = '/catalog/?action=sync';
                            break;
                        case 'sales-report':
                            window.location.href = '/sales/?view=report';
                            break;
                        case 'user-management':
                            window.location.href = '/user-management/';
                            break;
                        case 'system-monitoring':
                            window.location.href = '/monitoring/';
                            break;
                    }
                },

                async loadUserRole() {
                    try {
                        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                        console.log('Dashboard: Checking for token...', token ? 'Found' : 'Not found');
                        
                        if (!token) {
                            // No token - redirect to login
                            console.log('Dashboard: No token found, redirecting to login');
                            window.location.href = '/login.html';
                            return;
                        }

                        console.log('Dashboard: Making profile request with token');
                        const response = await fetch('/api/auth/profile', {
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        console.log('Dashboard: Profile response status:', response.status);
                        
                        if (response.ok) {
                            const result = await response.json();
                            console.log('Dashboard: Profile response data:', result);
                            
                            if (result.success) {
                                this.userRole = result.data.role;
                                console.log('Dashboard: User role loaded:', this.userRole);
                                console.log('Dashboard: Module visibility check:');
                                console.log('- Quotes:', this.canAccessModule('quotes'));
                                console.log('- Logs:', this.canAccessModule('logs'));
                                console.log('- Catalog:', this.canAccessModule('catalog'));
                                console.log('- Sales:', this.canAccessModule('sales'));
                                console.log('- Monitoring:', this.canAccessModule('monitoring'));
                            }
                        } else if (response.status === 401) {
                            // Token invalid - redirect to login
                            console.log('Dashboard: Token invalid, redirecting to login');
                            localStorage.removeItem('token');
                            sessionStorage.removeItem('token');
                            window.location.href = '/login.html';
                        }
                    } catch (error) {
                        console.error('Dashboard: Error loading user role:', error);
                        // On error, assume no auth - redirect to login
                        window.location.href = '/login.html';
                    }
                },

                async loadSystemStatus() {
                    try {
                        const response = await fetch('/api/monitoring/health');
                        if (response.ok) {
                            const result = await response.json();
                            if (result.success) {
                                this.systemStatus = result.data.status || 'unknown';
                            }
                        }
                    } catch (error) {
                        console.error('Error loading system status:', error);
                        this.systemStatus = 'unknown';
                    }
                },

                isAdmin() {
                    return this.userRole === 'admin';
                },

                isManager() {
                    return this.userRole === 'manager' || this.userRole === 'admin';
                },

                canAccessModule(module) {
                    if (!this.userRole) return false;

                    const permissions = {
                        'quotes': ['admin', 'manager', 'user'],
                        'logs': ['admin', 'manager'],
                        'catalog': ['admin', 'manager', 'user'],
                        'sales': ['admin', 'manager'],
                        'monitoring': ['admin']
                    };

                    return permissions[module]?.includes(this.userRole) || false;
                },
                

                formatCurrency(amount) {
                    return new Intl.NumberFormat('es-DO', {
                        style: 'currency',
                        currency: 'DOP'
                    }).format(amount);
                },

                logout() {
                    // Clear stored tokens
                    localStorage.removeItem('token');
                    localStorage.removeItem('refreshToken');
                    sessionStorage.removeItem('token');
                    sessionStorage.removeItem('refreshToken');

                    // Redirect to login page
                    window.location.href = '/login.html';
                }
            };
        }
    </script>
</body>
</html>