<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Analytics - Plaza Lama</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="../shared/theme.css" rel="stylesheet">
</head>
<body>
    <div x-data="salesApp()">
        <!-- Header -->
        <header class="unified-header sales-header">
            <div class="header-content">
                <div class="header-title">
                    <a href="/" class="back-button">
                        <i class="fas fa-arrow-left"></i>
                    </a>
                    <i class="fas fa-chart-line header-icon"></i>
                    Sales Analytics
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-sm text-gray-500">
                        Last Updated: <span x-text="lastUpdated"></span>
                    </div>
                    <div class="relative" x-data="{ showExportMenu: false }">
                        <button @click="showExportMenu = !showExportMenu" class="btn-secondary">
                            <i class="fas fa-download"></i>
                            Export
                            <i class="fas fa-chevron-down ml-1"></i>
                        </button>
                        <div x-show="showExportMenu" 
                             @click.away="showExportMenu = false"
                             class="absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-lg border border-gray-200 z-10">
                            <div class="py-2">
                                <button @click="exportSalesReport('pdf'); showExportMenu = false" 
                                        class="w-full text-left px-4 py-2 hover:bg-gray-50 flex items-center">
                                    <i class="fas fa-file-pdf text-red-500 mr-3"></i>
                                    Sales Report (PDF)
                                </button>
                                <button @click="exportSalesMetrics('excel'); showExportMenu = false" 
                                        class="w-full text-left px-4 py-2 hover:bg-gray-50 flex items-center">
                                    <i class="fas fa-file-excel text-green-500 mr-3"></i>
                                    Sales Metrics (Excel)
                                </button>
                                <button @click="exportTopProducts('excel'); showExportMenu = false" 
                                        class="w-full text-left px-4 py-2 hover:bg-gray-50 flex items-center">
                                    <i class="fas fa-file-excel text-green-500 mr-3"></i>
                                    Top Products (Excel)
                                </button>
                                <button @click="exportDailyTrends('excel'); showExportMenu = false" 
                                        class="w-full text-left px-4 py-2 hover:bg-gray-50 flex items-center">
                                    <i class="fas fa-file-excel text-green-500 mr-3"></i>
                                    Daily Trends (Excel)
                                </button>
                                <button @click="exportStorePerformance('excel'); showExportMenu = false" 
                                        class="w-full text-left px-4 py-2 hover:bg-gray-50 flex items-center">
                                    <i class="fas fa-file-excel text-green-500 mr-3"></i>
                                    Store Performance (Excel)
                                </button>
                            </div>
                        </div>
                    </div>
                    <button @click="refreshData()" class="btn-sales">
                        <i class="fas fa-sync-alt"></i>
                        Refresh
                    </button>
                </div>
            </div>
        </header>

        <!-- Content -->
        <main class="main-content">
            <!-- Module Overview -->
            <div class="mb-8">
                <div class="feature-card sales">
                    <i class="feature-icon fas fa-chart-line" aria-hidden="true"></i>
                    <h1 class="feature-title">Sales Analytics Platform</h1>
                    <p class="feature-description">
                        Real-time sales metrics and performance analysis system. Track revenue, monitor store performance, 
                        analyze customer insights, and generate comprehensive business intelligence reports.
                    </p>
                    
                    <div class="feature-stats">
                        <div class="stat-item">
                            <div class="stat-value" x-text="formatCurrency(stats.todayRevenue)" aria-live="polite">$12,547</div>
                            <div class="stat-label">Today's Revenue</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" x-text="stats.todayOrders.toLocaleString()" aria-live="polite">89</div>
                            <div class="stat-label">Today's Orders</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" x-text="formatCurrency(stats.monthlyRevenue)" aria-live="polite">$245,780</div>
                            <div class="stat-label">Monthly Revenue</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" x-text="stats.activeStores" aria-live="polite">8</div>
                            <div class="stat-label">Active Stores</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Feature Grid -->
            <section aria-labelledby="features-heading">
                <h2 id="features-heading" class="text-2xl font-bold text-gray-900 mb-6">Analytics Features</h2>
                <div class="feature-grid">
                    <!-- Revenue Tracking Feature -->
                    <div class="feature-card sales" 
                         role="button" 
                         tabindex="0"
                         @click="viewRevenue()"
                         @keydown.enter="viewRevenue()"
                         @keydown.space.prevent="viewRevenue()"
                         aria-describedby="revenue-desc">
                        <i class="feature-icon fas fa-chart-bar" aria-hidden="true"></i>
                        <h3 class="feature-title">Revenue Tracking</h3>
                        <p id="revenue-desc" class="feature-description">
                            Monitor daily and monthly sales performance with trend analysis and forecasting capabilities.
                        </p>
                        <div class="mt-6">
                            <div class="btn btn-sales">
                                <i class="fas fa-chart-line" aria-hidden="true"></i>
                                View Revenue
                            </div>
                        </div>
                    </div>

                    <!-- Store Analytics Feature -->
                    <div class="feature-card sales" 
                         role="button" 
                         tabindex="0"
                         @click="viewStores()"
                         @keydown.enter="viewStores()"
                         @keydown.space.prevent="viewStores()"
                         aria-describedby="stores-desc">
                        <i class="feature-icon fas fa-building" aria-hidden="true"></i>
                        <h3 class="feature-title">Store Analytics</h3>
                        <p id="stores-desc" class="feature-description">
                            Compare performance across multiple stores with location-based metrics and benchmarking.
                        </p>
                        <div class="mt-6">
                            <div class="btn btn-sales">
                                <i class="fas fa-store" aria-hidden="true"></i>
                                View Stores
                            </div>
                        </div>
                    </div>

                    <!-- Product Insights Feature -->
                    <div class="feature-card sales" 
                         role="button" 
                         tabindex="0"
                         @click="viewProducts()"
                         @keydown.enter="viewProducts()"
                         @keydown.space.prevent="viewProducts()"
                         aria-describedby="products-desc">
                        <i class="feature-icon fas fa-boxes" aria-hidden="true"></i>
                        <h3 class="feature-title">Product Insights</h3>
                        <p id="products-desc" class="feature-description">
                            Analyze top-selling products, seasonal trends, and inventory performance metrics.
                        </p>
                        <div class="mt-6">
                            <div class="btn btn-sales">
                                <i class="fas fa-chart-pie" aria-hidden="true"></i>
                                View Products
                            </div>
                        </div>
                    </div>

                    <!-- Customer Analytics Feature -->
                    <div class="feature-card sales" 
                         role="button" 
                         tabindex="0"
                         @click="viewCustomers()"
                         @keydown.enter="viewCustomers()"
                         @keydown.space.prevent="viewCustomers()"
                         aria-describedby="customers-desc">
                        <i class="feature-icon fas fa-users" aria-hidden="true"></i>
                        <h3 class="feature-title">Customer Analytics</h3>
                        <p id="customers-desc" class="feature-description">
                            Understand customer behavior, purchase patterns, and lifetime value analysis.
                        </p>
                        <div class="mt-6">
                            <div class="btn btn-sales">
                                <i class="fas fa-user-friends" aria-hidden="true"></i>
                                View Customers
                            </div>
                        </div>
                    </div>

                    <!-- Sales Reports Feature -->
                    <div class="feature-card sales" 
                         role="button" 
                         tabindex="0"
                         @click="generateReports()"
                         @keydown.enter="generateReports()"
                         @keydown.space.prevent="generateReports()"
                         aria-describedby="reports-desc">
                        <i class="feature-icon fas fa-file-chart-line" aria-hidden="true"></i>
                        <h3 class="feature-title">Sales Reports</h3>
                        <p id="reports-desc" class="feature-description">
                            Generate comprehensive sales reports with custom date ranges and detailed breakdowns.
                        </p>
                        <div class="mt-6">
                            <div class="btn btn-sales">
                                <i class="fas fa-file-alt" aria-hidden="true"></i>
                                Generate Reports
                            </div>
                        </div>
                    </div>

                    <!-- Performance Metrics Feature -->
                    <div class="feature-card sales" 
                         role="button" 
                         tabindex="0"
                         @click="viewMetrics()"
                         @keydown.enter="viewMetrics()"
                         @keydown.space.prevent="viewMetrics()"
                         aria-describedby="metrics-desc">
                        <i class="feature-icon fas fa-tachometer-alt" aria-hidden="true"></i>
                        <h3 class="feature-title">Performance Metrics</h3>
                        <p id="metrics-desc" class="feature-description">
                            Track KPIs, conversion rates, and performance indicators with real-time dashboards.
                        </p>
                        <div class="mt-6">
                            <div class="btn btn-sales">
                                <i class="fas fa-chart-area" aria-hidden="true"></i>
                                View Metrics
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Top Products -->
            <div class="theme-card" x-show="topProducts.length > 0">
                <h3 class="text-lg font-semibold mb-4">Top Selling Products (Today)</h3>
                <div class="theme-table">
                    <table class="w-full">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Units Sold</th>
                                <th>Revenue</th>
                                <th>Trend</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="product in topProducts.slice(0, 5)" :key="product.codigo">
                                <tr>
                                    <td>
                                        <div class="font-medium" x-text="product.nombre"></div>
                                        <div class="text-sm text-gray-500" x-text="product.codigo"></div>
                                    </td>
                                    <td x-text="product.quantity.toLocaleString()"></td>
                                    <td x-text="formatCurrency(product.revenue)"></td>
                                    <td>
                                        <i class="fas fa-arrow-up text-green-500"></i>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        function salesApp() {
            return {
                lastUpdated: new Date().toLocaleString(),
                stats: {
                    todayRevenue: 0,
                    todayOrders: 0,
                    monthlyRevenue: 0,
                    activeStores: 0
                },
                topProducts: [],
                loading: false,

                async init() {
                    await this.loadStats();
                    await this.loadTopProducts();
                },

                async loadStats() {
                    try {
                        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                        if (!token) {
                            window.location.href = '/login.html';
                            return;
                        }

                        const response = await fetch('/api/sales/stats', {
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        if (response.ok) {
                            const result = await response.json();
                            if (result.success) {
                                this.stats = result.data;
                            }
                        }
                    } catch (error) {
                        console.error('Error loading sales stats:', error);
                    }
                },

                async loadTopProducts() {
                    try {
                        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                        const response = await fetch('/api/sales/top-products', {
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        if (response.ok) {
                            const result = await response.json();
                            if (result.success) {
                                this.topProducts = result.data;
                            }
                        }
                    } catch (error) {
                        console.error('Error loading top products:', error);
                    }
                },

                async refreshData() {
                    this.loading = true;
                    await Promise.all([
                        this.loadStats(),
                        this.loadTopProducts()
                    ]);
                    this.lastUpdated = new Date().toLocaleString();
                    this.loading = false;
                },

                viewRevenue() {
                    alert('Revenue details will be implemented');
                },

                viewStores() {
                    alert('Store analytics will be implemented');
                },

                viewProducts() {
                    alert('Product insights will be implemented');
                },
                
                viewCustomers() {
                    alert('Customer analytics will be implemented');
                },
                
                generateReports() {
                    alert('Sales reports will be implemented');
                },
                
                viewMetrics() {
                    alert('Performance metrics will be implemented');
                },

                formatCurrency(amount) {
                    return new Intl.NumberFormat('es-DO', {
                        style: 'currency',
                        currency: 'DOP'
                    }).format(amount || 0);
                },

                async exportSalesReport(format) {
                    try {
                        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                        const response = await fetch(`/api/sales/export/report/${format}`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });

                        if (response.ok) {
                            const blob = await response.blob();
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `sales_report_${new Date().toISOString().split('T')[0]}.${format}`;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            window.URL.revokeObjectURL(url);
                        } else {
                            alert('Export failed. Please try again.');
                        }
                    } catch (error) {
                        console.error('Export error:', error);
                        alert('Export failed. Please try again.');
                    }
                },

                async exportSalesMetrics(format) {
                    try {
                        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                        const response = await fetch(`/api/sales/export/metrics/${format}`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });

                        if (response.ok) {
                            const blob = await response.blob();
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `sales_metrics_${new Date().toISOString().split('T')[0]}.${format === 'excel' ? 'xlsx' : format}`;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            window.URL.revokeObjectURL(url);
                        } else {
                            alert('Export failed. Please try again.');
                        }
                    } catch (error) {
                        console.error('Export error:', error);
                        alert('Export failed. Please try again.');
                    }
                },

                async exportTopProducts(format) {
                    try {
                        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                        const response = await fetch(`/api/sales/export/products/${format}`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });

                        if (response.ok) {
                            const blob = await response.blob();
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `top_products_${new Date().toISOString().split('T')[0]}.xlsx`;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            window.URL.revokeObjectURL(url);
                        } else {
                            alert('Export failed. Please try again.');
                        }
                    } catch (error) {
                        console.error('Export error:', error);
                        alert('Export failed. Please try again.');
                    }
                },

                async exportDailyTrends(format) {
                    try {
                        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                        const response = await fetch(`/api/sales/export/trends/${format}`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });

                        if (response.ok) {
                            const blob = await response.blob();
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `daily_trends_${new Date().toISOString().split('T')[0]}.xlsx`;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            window.URL.revokeObjectURL(url);
                        } else {
                            alert('Export failed. Please try again.');
                        }
                    } catch (error) {
                        console.error('Export error:', error);
                        alert('Export failed. Please try again.');
                    }
                },

                async exportStorePerformance(format) {
                    try {
                        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                        const response = await fetch(`/api/sales/export/stores/${format}`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });

                        if (response.ok) {
                            const blob = await response.blob();
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `store_performance_${new Date().toISOString().split('T')[0]}.xlsx`;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            window.URL.revokeObjectURL(url);
                        } else {
                            alert('Export failed. Please try again.');
                        }
                    } catch (error) {
                        console.error('Export error:', error);
                        alert('Export failed. Please try again.');
                    }
                }
            };
        }
    </script>
</body>
</html>