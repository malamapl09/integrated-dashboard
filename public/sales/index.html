<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Analytics - Plaza Lama</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="../shared/theme.css" rel="stylesheet">
</head>
<body>
    <div x-data="salesApp()">
        <!-- Header -->
        <header class="unified-header sales-header">
            <div class="header-content">
                <div class="header-title">
                    <a href="/" class="back-button">
                        <i class="fas fa-arrow-left"></i>
                    </a>
                    <i class="fas fa-chart-line header-icon"></i>
                    Sales Analytics
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-sm text-gray-500">
                        Last Updated: <span x-text="lastUpdated"></span>
                    </div>
                    <div class="relative" x-data="{ showExportMenu: false }">
                        <button @click="showExportMenu = !showExportMenu" class="btn-secondary">
                            <i class="fas fa-download"></i>
                            Export
                            <i class="fas fa-chevron-down ml-1"></i>
                        </button>
                        <div x-show="showExportMenu" 
                             @click.away="showExportMenu = false"
                             class="absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-lg border border-gray-200 z-10">
                            <div class="py-2">
                                <button @click="exportSalesReport('pdf'); showExportMenu = false" 
                                        class="w-full text-left px-4 py-2 hover:bg-gray-50 flex items-center">
                                    <i class="fas fa-file-pdf text-red-500 mr-3"></i>
                                    Sales Report (PDF)
                                </button>
                                <button @click="exportSalesMetrics('excel'); showExportMenu = false" 
                                        class="w-full text-left px-4 py-2 hover:bg-gray-50 flex items-center">
                                    <i class="fas fa-file-excel text-green-500 mr-3"></i>
                                    Sales Metrics (Excel)
                                </button>
                                <button @click="exportTopProducts('excel'); showExportMenu = false" 
                                        class="w-full text-left px-4 py-2 hover:bg-gray-50 flex items-center">
                                    <i class="fas fa-file-excel text-green-500 mr-3"></i>
                                    Top Products (Excel)
                                </button>
                                <button @click="exportDailyTrends('excel'); showExportMenu = false" 
                                        class="w-full text-left px-4 py-2 hover:bg-gray-50 flex items-center">
                                    <i class="fas fa-file-excel text-green-500 mr-3"></i>
                                    Daily Trends (Excel)
                                </button>
                                <button @click="exportStorePerformance('excel'); showExportMenu = false" 
                                        class="w-full text-left px-4 py-2 hover:bg-gray-50 flex items-center">
                                    <i class="fas fa-file-excel text-green-500 mr-3"></i>
                                    Store Performance (Excel)
                                </button>
                            </div>
                        </div>
                    </div>
                    <button @click="refreshData()" class="btn-sales">
                        <i class="fas fa-sync-alt"></i>
                        Refresh
                    </button>
                </div>
            </div>
        </header>

        <!-- Content -->
        <main class="main-content">
            <!-- Key Metrics -->
            <div class="content-grid grid-4 mb-8">
                <div class="theme-card">
                    <div class="text-center">
                        <i class="fas fa-dollar-sign text-3xl mb-3" style="color: var(--sales-text);"></i>
                        <div class="text-2xl font-bold mb-1" x-text="formatCurrency(stats.todayRevenue)">-</div>
                        <div class="text-sm text-gray-600">Today's Revenue</div>
                    </div>
                </div>
                <div class="theme-card">
                    <div class="text-center">
                        <i class="fas fa-shopping-cart text-3xl mb-3" style="color: var(--sales-text);"></i>
                        <div class="text-2xl font-bold mb-1" x-text="stats.todayOrders.toLocaleString()">-</div>
                        <div class="text-sm text-gray-600">Today's Orders</div>
                    </div>
                </div>
                <div class="theme-card">
                    <div class="text-center">
                        <i class="fas fa-calendar-month text-3xl mb-3" style="color: var(--sales-text);"></i>
                        <div class="text-2xl font-bold mb-1" x-text="formatCurrency(stats.monthlyRevenue)">-</div>
                        <div class="text-sm text-gray-600">Monthly Revenue</div>
                    </div>
                </div>
                <div class="theme-card">
                    <div class="text-center">
                        <i class="fas fa-store text-3xl mb-3" style="color: var(--sales-text);"></i>
                        <div class="text-2xl font-bold mb-1" x-text="stats.activeStores">-</div>
                        <div class="text-sm text-gray-600">Active Stores</div>
                    </div>
                </div>
            </div>

            <!-- Analytics Cards -->
            <div class="content-grid grid-3 mb-8">
                <div class="gradient-card sales">
                    <div class="text-center">
                        <i class="fas fa-chart-bar text-4xl mb-4"></i>
                        <h3 class="text-xl font-bold mb-3">Revenue Tracking</h3>
                        <p class="text-sm opacity-90 mb-6">Monitor daily and monthly sales performance</p>
                        <button @click="viewRevenue()" class="btn-secondary">
                            <i class="fas fa-chart-line"></i>
                            View Details
                        </button>
                    </div>
                </div>

                <div class="gradient-card sales">
                    <div class="text-center">
                        <i class="fas fa-building text-4xl mb-4"></i>
                        <h3 class="text-xl font-bold mb-3">Store Analytics</h3>
                        <p class="text-sm opacity-90 mb-6">Compare performance across multiple stores</p>
                        <button @click="viewStores()" class="btn-secondary">
                            <i class="fas fa-store"></i>
                            View Stores
                        </button>
                    </div>
                </div>

                <div class="gradient-card sales">
                    <div class="text-center">
                        <i class="fas fa-boxes text-4xl mb-4"></i>
                        <h3 class="text-xl font-bold mb-3">Product Insights</h3>
                        <p class="text-sm opacity-90 mb-6">Analyze top-selling products and trends</p>
                        <button @click="viewProducts()" class="btn-secondary">
                            <i class="fas fa-chart-pie"></i>
                            View Products
                        </button>
                    </div>
                </div>
            </div>

            <!-- Top Products -->
            <div class="theme-card" x-show="topProducts.length > 0">
                <h3 class="text-lg font-semibold mb-4">Top Selling Products (Today)</h3>
                <div class="theme-table">
                    <table class="w-full">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Units Sold</th>
                                <th>Revenue</th>
                                <th>Trend</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="product in topProducts.slice(0, 5)" :key="product.codigo">
                                <tr>
                                    <td>
                                        <div class="font-medium" x-text="product.nombre"></div>
                                        <div class="text-sm text-gray-500" x-text="product.codigo"></div>
                                    </td>
                                    <td x-text="product.quantity.toLocaleString()"></td>
                                    <td x-text="formatCurrency(product.revenue)"></td>
                                    <td>
                                        <i class="fas fa-arrow-up text-green-500"></i>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        function salesApp() {
            return {
                lastUpdated: new Date().toLocaleString(),
                stats: {
                    todayRevenue: 0,
                    todayOrders: 0,
                    monthlyRevenue: 0,
                    activeStores: 0
                },
                topProducts: [],
                loading: false,

                async init() {
                    await this.loadStats();
                    await this.loadTopProducts();
                },

                async loadStats() {
                    try {
                        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                        if (!token) {
                            window.location.href = '/login.html';
                            return;
                        }

                        const response = await fetch('/api/sales/stats', {
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        if (response.ok) {
                            const result = await response.json();
                            if (result.success) {
                                this.stats = result.data;
                            }
                        }
                    } catch (error) {
                        console.error('Error loading sales stats:', error);
                    }
                },

                async loadTopProducts() {
                    try {
                        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                        const response = await fetch('/api/sales/top-products', {
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        if (response.ok) {
                            const result = await response.json();
                            if (result.success) {
                                this.topProducts = result.data;
                            }
                        }
                    } catch (error) {
                        console.error('Error loading top products:', error);
                    }
                },

                async refreshData() {
                    this.loading = true;
                    await Promise.all([
                        this.loadStats(),
                        this.loadTopProducts()
                    ]);
                    this.lastUpdated = new Date().toLocaleString();
                    this.loading = false;
                },

                viewRevenue() {
                    alert('Revenue details will be implemented');
                },

                viewStores() {
                    alert('Store analytics will be implemented');
                },

                viewProducts() {
                    alert('Product insights will be implemented');
                },

                formatCurrency(amount) {
                    return new Intl.NumberFormat('es-DO', {
                        style: 'currency',
                        currency: 'DOP'
                    }).format(amount || 0);
                },

                async exportSalesReport(format) {
                    try {
                        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                        const response = await fetch(`/api/sales/export/report/${format}`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });

                        if (response.ok) {
                            const blob = await response.blob();
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `sales_report_${new Date().toISOString().split('T')[0]}.${format}`;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            window.URL.revokeObjectURL(url);
                        } else {
                            alert('Export failed. Please try again.');
                        }
                    } catch (error) {
                        console.error('Export error:', error);
                        alert('Export failed. Please try again.');
                    }
                },

                async exportSalesMetrics(format) {
                    try {
                        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                        const response = await fetch(`/api/sales/export/metrics/${format}`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });

                        if (response.ok) {
                            const blob = await response.blob();
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `sales_metrics_${new Date().toISOString().split('T')[0]}.${format === 'excel' ? 'xlsx' : format}`;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            window.URL.revokeObjectURL(url);
                        } else {
                            alert('Export failed. Please try again.');
                        }
                    } catch (error) {
                        console.error('Export error:', error);
                        alert('Export failed. Please try again.');
                    }
                },

                async exportTopProducts(format) {
                    try {
                        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                        const response = await fetch(`/api/sales/export/products/${format}`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });

                        if (response.ok) {
                            const blob = await response.blob();
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `top_products_${new Date().toISOString().split('T')[0]}.xlsx`;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            window.URL.revokeObjectURL(url);
                        } else {
                            alert('Export failed. Please try again.');
                        }
                    } catch (error) {
                        console.error('Export error:', error);
                        alert('Export failed. Please try again.');
                    }
                },

                async exportDailyTrends(format) {
                    try {
                        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                        const response = await fetch(`/api/sales/export/trends/${format}`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });

                        if (response.ok) {
                            const blob = await response.blob();
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `daily_trends_${new Date().toISOString().split('T')[0]}.xlsx`;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            window.URL.revokeObjectURL(url);
                        } else {
                            alert('Export failed. Please try again.');
                        }
                    } catch (error) {
                        console.error('Export error:', error);
                        alert('Export failed. Please try again.');
                    }
                },

                async exportStorePerformance(format) {
                    try {
                        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                        const response = await fetch(`/api/sales/export/stores/${format}`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });

                        if (response.ok) {
                            const blob = await response.blob();
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `store_performance_${new Date().toISOString().split('T')[0]}.xlsx`;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            window.URL.revokeObjectURL(url);
                        } else {
                            alert('Export failed. Please try again.');
                        }
                    } catch (error) {
                        console.error('Export error:', error);
                        alert('Export failed. Please try again.');
                    }
                }
            };
        }
    </script>
</body>
</html>